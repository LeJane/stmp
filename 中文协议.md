# STMP

一个比MQTT还要简洁的长连接消息协议.

目前在嵌入式设备或者消息通知系统中, 用的最多的应该就是MQTT协议了, 但是这个协议在协议层添加了`QoS`控制, 这就导致连接层变得十分臃肿.
在做长连接APP的时候, 大部分时间都用不到这一特性. 需要的只是组织连接中的消息的一种方式, 使得双端收到消息后能够被应用正确处理就行了.
这个协议的目的就是解决这种场景下的应用开发底层消息通讯问题.

---

## 版本

协议版本有两个字段, 分别为`MAJOR`和`MINOR`, 二者取值范围均为`0`到`15`, 即`0x0`到`0xF`, 可以序列化为`MAJOR.MINOR`的形式.

当前协议版本为`0.1`.

## 字段描述

本协议中, 除了实际负载(PAYLOAD)之外, 还带有若干个标志性字段. 所有可能的字段包括:

- 消息类型 `KIND`: 必需
- 负载编码方式 `ENCODING`: 必需
- 消息ID `ID`: 可选
- 请求动作 `ACTION`: 可选
- 状态码 `STATUS`: 可选
- 负载长度 `PS`: 可选
- 负载 `PAYLOAD`: 可选

如果某条消息存在以上字段的某些字段, 则这些字段**一定**按照上面的顺序进行排列.

### 消息类型 KIND

**必需**, 此字段标志此条消息的类型, 取值从`0`到`3`, 可能的消息类型如下:

- `0`: 心跳消息 `Ping Message`
- `1`: 请求消息 `Request Message`
- `2`: 通知消息 `Notify Message`
- `3`: 回复消息 `Response Message`

### 负载编码方式 ENCODING

**必需**, 表示负载(PAYLOAD)的格式, 取值从`0`到`7`, 可能的编码方式如下:

- `0`: 保留格式, 表示负载为空, 此时**一定不**存在`PS`字段
- `1`: Protocol Buffers
- `2`: JSON
- `3`: MessagePack
- `4`: BSON
- `5`: Raw, 表示负载为原始数据, 不需要解码, 但是**一定不**为空

### 消息ID ID

**可选**, 表示当前消息的ID, 取值范围从`0x0000`到`0xFFFF`, 双端都应该保证此值在一定时期范围内不会重复. 此字段用在请求和回复类型消息
中, 一端在收到回复消息后**应该**用此字段去匹配相应的请求消息.

### 请求动作 ACTION

**可选**, 用在请求和通知消息中, 取值范围从`0x00000000`到`0xFFFFFFFF`, 此字段用于上层应用区别请求的资源. 其中`0x00`到`0xFF`为保留
动作ID, 以供协议内部使用, 目前已定义的ACTION如下:

- `0x00`: 版本校验 Check Versions

### 状态码 STATUS

**可选**, 用在回复消息中, 表示回复收到请求消息的一端的处理结果的状态, 聚会范围从`0x00`到`0xFF`, 其中`0x00`到`0x7F`为保留取值区间.
用以表示某些特定的公共状态, `0x80`到`0xFF`为用户自定义值, 这些值可能根据`ACTION`不同而具有不同的含义. 以定义的状态码如下:

- `0x00`: 正常, Ok, 200
- `0x10`: 资源已转移 MovedPermanently, 301
- `0x11`: 资源已转移 Found, 302
- `0x12`: 资源未更新 NotModified, 304
- `0x20`: 请求无效 BadRequest, 400
- `0x21`: 未授权 Unauthorized, 401
- `0x22`: 需要支付 PaymentRequired, 402
- `0x23`: 禁止访问 Forbidden, 403
- `0x24`: 资源不存在 NotFound, 404
- `0x25`: 请求超时 RequestTimeout, 408
- `0x26`: 负载过大 RequestEntityTooLarge, 413
- `0x27`: 请求过于频繁 TooManyRequests, 429
- `0x30`: 服务器内部错误 InternalServerError, 500
- `0x31`: 未实现 NotImplemented, 501
- `0x32`: 网关错误 BadGateway, 502
- `0x33`: 服务异常 ServiceUnavailable, 503
- `0x34`: 网关超时 GatewayTimeout, 504
- `0x35`: 协议版本不支持 VersionNotSupported, 505

### 负载长度 PS

**可选**, 表示负载的长度, 取值范围为`0x00000000`到`0xFFFFFFFF`, 如果一个消息中不包含负载, 则此字段**一定不**存在. 此外, 此字段还由
底层网络协议决定是否存在, 如果一个网络协议可以有效的分包, 对消息进行隔离, 则此字段**不应该**存在, 比如对于`WebSockets`协议, 则不需要
此协议, 而对于`TCP/UDP`, 则此字段是必需的(如果有负载的话).

### 负载 PAYLOAD

**可选**, 此字段表示消息实际的负载, 除了心跳消息一定不包含此字段外, 其它消息均可以携带负载, 其长度由PS字段决定.

## 消息类型

### 心跳消息 Ping Request

在双边连接建立后, 双方都必需定期发送心跳消息到对方, 如果在一个指定时间内未收到心跳消息, 则此端必需关闭连接, 另一端在探测到对方已关闭连接
后, 必需关闭连接, 亦即**不允许**单边连接. 此消息不需要回复, 但是双边都必需保证对方能在有效时间内收到此消息.

**一定不**包含任何可选字段.

### 请求消息 Request Message

此消息表示发送端在请求一个对方的资源, 接收方应该通过`ACTION`字段来区分具体请求的资源是什么, 接收方在处理完毕后必需回应此消息, 回应的消息
`ID`字段必需与此消息的`ID`字段相同, 以供发送方进行区分, 如果发送方在特定的时间内未收到回复, 则会向上层应用传递一个`请求超时`的回复并忽略
后续收到的`ID`与此消息相同的回复消息.

**一定**包含`ID`, `ACTION`字段, **可能**包含`PAYLOAD`, `PS`字段, **一定不**包含`STATUS`字段.

### 通知消息 Notify Message

此消息表示发送方向接收方传递一个消息通知, 接收方在收到后无需回复.

**一定**包含`ACTION`字段, **可能**包含`PAYLOAD`, `PS`字段, **一定不**包含`ID`, `STATUS`字段.

### 回复消息 Response Message

此消息表示发送方向接收方传递一个回复, 回复对方发送过的某一条请求消息, 通过`ID`字段进行配对. 通过`STATUS`字段表示发送方处理的结果状态.

**一定**包含`ID`, `STATUS`字段, **可能**包含`PAYLOAD`, `PS`字段, **一定不**包含`ACTION`字段.

## 消息序列化

某些特定场景(比如浏览器), 处理二进制数据的效率没有处理字段的效率高(将字符串转换为UTF-8编码的二进制数据), 因此根据不同的场景制定了两种
不同的序列化方式: 二进制格式和文本格式, 二者均可传递文本格式或者二进制格式的负载, 由底层网络协议决定, 区别在于标志字段的序列化方式.

### 二进制序列化

对于一个包含所有字段的消息, 其格式如下:

    |   0 ... 7   |  8 ... 15  |  16 ... 23  |  24 ... 31  |
    | FIXED_HEADER|           ID             |    ACTION   |
    |               ACTION                   |    STATUS   |
    |                         PS                           |
    |                 PAYLOAD    ...                       |

其中`FIXED_HEADER`为所有消息都共有的字段, 包含了所有必需的字段:

    |   0   |   1   |   2   |   3   |   4   |   5   |   6   |   7   |
    |     KIND      |       ENCODING        |   0   |   0   |   0   |

对于可选字段, 如果一个消息中不存在此字段, 则不应该出现在消息中, 并且其后续的字段相应的往前移. 所有的多字节字段(PAYLOAD)除外,
均采用BE格式.

对于`PingMessage`, 其长度为1byte, 值为`0`

### 文本格式

各个字段均序列化为文本格式, 以`'|'`连接, 即格式如下:

```text
KIND(1)|ENCODING(1)|ID?(1-5)|ACTION?(1-10)|STATUS?(1-3)|PS?(1-10)|PAYLOAD?(...)
```
对于`PingMessage`, 其长度为1byte, 值为`'0'`

### 二进制消息与文本消息的区分

对于二进制消息, 其首字节要么为`0`(PingMessage), 要么大于`0x40`(其它类型的消息, 首2bit值不全为零). 而对于文本消息, 首字节的取值范围
为`'0'`, `'1'`, `'2'`, `'3'`, 即`0x30`到`0x33`, 与二进制消息完全不同. 因此可以直接区分.

## 版本校验

客户端在发起连接成功后, 需要发送一个ACTION为`0x00`的消息给服务端, 消息ID必需为`0`, 负载编码方式为`Raw`, 负载为客户端可接受的版本号
列表. 服务端在收到此消息后, 如果可以处理客户端发送过来的版本列表中的某一个, 则回复一个STATUS为`Ok`的回复消息, 负载为所选择的协议版本
号, 如果不能处理, 则返回一个`VersionNotSupported`错误消息, 负载为空, 并且关闭连接.

### 版本号序列化

在二进制消息中, 一个版本号序列化为1字节长度的信息, 其中前4位为`MAJOR`, 后4位为`MINOR`值. 多个版本号直接连接在一起.

在文本消息中, 一个版本号序列化为2字节长度的信息, 其中前1字节为`MAJOR`, 后1字节为`MINOR`值, 多个版本号直接相连.
